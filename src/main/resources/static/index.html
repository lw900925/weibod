<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>weibod</title>
  <script src="js/vue-2.7.14.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
  <div id="app">
    <div class="navbar">
      <div class="navbar-content">
        <input type="text" v-model="inputText" placeholder="请输入uid..." @keyup.enter="startStream">
        <label class="navbar-checkbox">
          <input type="checkbox" v-model="filters.livephoto">
          <span class="checkbox-text">实况照片</span>
        </label>
        <label class="navbar-checkbox">
          <input type="checkbox" v-model="filters.video">
          <span class="checkbox-text">视频</span>
        </label>
        <label class="navbar-checkbox">
          <input type="checkbox" v-model="filters.picture">
          <span class="checkbox-text">图片</span>
        </label>
        <button @click="startStream" :disabled="loading">{{ loading ? '处理中...' : '开始' }}</button>
      </div>
    </div>
    <div class="terminal">
      <pre v-html="terminalContent"></pre>
    </div>
  </div>
  <script>
    new Vue({
      el: '#app',
      data: {
        inputText: '',
        terminalContent: '没有正在下载的用户...',
        loading: false,
        eventSource: null,
        filters: {
          livephoto: true,
          video: false,
          picture: false
        }
      },
      computed: {
        filterType() {
          const selectedFilters = [];
          if (this.filters.livephoto) selectedFilters.push('livephoto');
          if (this.filters.video) selectedFilters.push('video');
          if (this.filters.picture) selectedFilters.push('picture');
          return selectedFilters.length > 0 ? selectedFilters.join(',') : 'none';
        }
      },
      methods: {
        startStream() {
          if (!this.inputText.trim() || this.loading) return;
          this.terminalContent = '';
          this.loading = true;
          if (this.eventSource) {
            this.eventSource.close();
          }
          // 拼接参数到URL
          const url = `/start?uid=${encodeURIComponent(this.inputText)}&filters=${encodeURIComponent(this.filterType)}`;
          this.eventSource = new EventSource(url);
          this.eventSource.onmessage = (event) => {
            this.terminalContent += '<prompt>' + event.data + '</prompt>\n';
          };
          this.eventSource.onerror = () => {
            this.loading = false;
            if (this.eventSource) {
              this.eventSource.close();
              this.eventSource = null;
            }
          };
          this.eventSource.onopen = () => {
            this.loading = false;
          };
        }
      },
      beforeDestroy() {
        if (this.eventSource) {
          this.eventSource.close();
        }
      }
    });
  </script>
</body>

</html>